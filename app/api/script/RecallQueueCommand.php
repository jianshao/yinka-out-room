<?php

namespace app\api\script;

use app\domain\exceptions\FQException;
use app\domain\recall\dao\PushRecallConfModelDao;
use app\domain\recall\queue\AmpQueue;
use app\domain\recall\service\MemberRecallService;
use app\utils\Error;
use think\console\Command;
use think\console\Input;
use think\console\input\Argument;
use think\console\Output;
use think\facade\Log;

ini_set('set_time_limit', 0);

/**
 * @info  用户召回（长期活动队列）
 * Class RecallQueueCommand
 * @package app\api\script
 * @command  php think RecallQueueCommand handler >> /tmp/RecallQueueCommandHandler.log 2>&1
 * @command  php think RecallQueueCommand handlerUserPush >> /tmp/RecallQueueCommandHandlerUserPush.log 2>&1
 * @command  php think RecallQueueCommand testPublisher >> /tmp/RecallQueueTestPublisher.log 2>&1
 * @command  php think RecallQueueCommand testConsumer >> /tmp/RecallQueueTestConsumer.log 2>&1
 */
class RecallQueueCommand extends Command
{
    private $offset = 0;
    private $endOffset = 0;
    private $recallSendUserSetKey = "recallQueue";
    private $smsTemplate = '【音恋语音】{$var},来领动态头像框~已放入您的背包rongqii.cn/{$var}拒D';
    private $deadqueueListKey = "recallSmsDeadqueue";
    private $appDev;

    const COMMAND_NAME = "RecallQueueCommand";

    protected function configure()
    {
        // 指令配置
        $this->setName('app\command\RecallQueueCommand')
            ->addArgument('func', Argument::OPTIONAL, "switch func")
            ->addArgument('id', Argument::OPTIONAL, "zb_push_recall_conf id")
            ->setDescription('user cancellation check');
    }

    private function getUnixTime()
    {
        return time();
    }

    private function getDateTime()
    {
        return date("Y-m-d H:i:s", $this->getUnixTime());
    }

    protected function execute(Input $input, Output $output)
    {
        $func = $input->getArgument('func') ?: "handler";
        $output->writeln(sprintf('app\command\RecallQueueCommand entry func:%s offset:%d endOffset:%d date:%s', $func, $this->offset, $this->endOffset, $this->getDateTime()));
        try {
            $refreshNumber = $this->{$func}();
        } catch (\Exception $e) {
            $output->writeln(sprintf("app\command\RecallQueueCommand execute func:%s date:%s error:%s error trice:%s", $func, $this->getDateTime(), $e->getMessage(), $e->getTraceAsString()));
            return;
        }
        // 指令输出
        $output->writeln(sprintf('app\command\RecallQueueCommand success end func:%s date:%s exec refreshNumber:%d', $func, $this->getDateTime(), $refreshNumber));
    }

    /**
     * @info 启动召回-任务解析消费者 member_recall_test
     * @param Output $output
     * @return int
     */
    private function handler()
    {
        $output = $this->output;
        $callback = function ($msg) use ($output) {
            $logmsg = sprintf("RecallQueueCommand handler taskConsumer msgBody:%s", $msg->body);
            $output->info($logmsg);
            Log::info($logmsg);
            if ($msg->body) {
                MemberRecallService::getInstance()->taskConsumer($msg);
            }
        };
        AmpQueue::getInstance()->consumer($callback);
        return 1;
    }

    /**
     * @info 启动召回-用户推送执行消费者 member_recall_user_push_test
     * @param Output $output
     * @return int
     */
    private function handlerUserPush()
    {
        $output = $this->output;
        $callback = function ($msg) use ($output) {
            $logmsg = sprintf("RecallQueueCommand UserPushConsumer entry msgBody:%s", $msg->body);
            $output->info($logmsg);
            Log::info($logmsg);
            if ($msg->body) {
                MemberRecallService::getInstance()->userPushConsumer($msg);
            }
        };
        AmpQueue::getInstance()->consumerUserPush($callback);
        return 1;
    }


    /**
     * @info 触达用户, 根据传入的配置id创建扫描任务队列
     * @return bool
     * @throws FQException
     */
    private function touchUsers()
    {
        $inputId = $this->input->getArgument('id');
        $id = $inputId ? (int)$inputId : 0;
        if (empty($id)) {
            throw new FQException(Error::getInstance()->GetMsg(Error::INVALID_PARAMS), Error::INVALID_PARAMS);
        }
        $pushTypeConfModel = PushRecallConfModelDao::getInstance()->loadModel($id);
        if ($pushTypeConfModel === null) {
            throw new FQException("push data error", 500);
        }
//        创建任务
        return MemberRecallService::getInstance()->createQueue($pushTypeConfModel);
    }


    /**
     * @throws FQException
     * demo :"{"id":117,"push_when":{"charge_max":0,"charge_min":0,"time":86400},"push_type":"rtdsms","template_ids":"[14]"}"
     */
    public function testRtdSmsCusumerTask()
    {
        $originStr = '{"id":123,"push_when":{"charge_max":0,"charge_min":0,"time":2592000},"push_type":"rtdsms","template_ids":"[\"20\",\"21\",\"22\"]"}';
//        $originStr = '{"id":117,"push_when":{"charge_max":0,"charge_min":0,"time":86400},"push_type":"rtdsms","template_ids":"[\"14\"]"}';
        $originData = json_decode($originStr, true);
        $re = MemberRecallService::getInstance()->handlerQueueConsumer($originData);
        var_dump($re);
        die;
    }

    /**
     * @throws FQException
     * @demo {"push_recall_conf":"{\"id\":117,\"push_when\":{\"charge_max\":0,\"charge_min\":0,\"time\":86400},\"push_type\":\"rtdsms\",\"template_ids\":\"[14]\"}","user_ids":"[1702863,1702862,1697567,1697566]"}
     */
    public function testRtdSmsCusumerUserPush()
    {
//        $originStr = '{"push_recall_conf":"{\"id\":117,\"push_when\":{\"charge_max\":0,\"charge_min\":0,\"time\":86400},\"push_type\":\"rtdsms\",\"template_ids\":\"[14]\"}","user_ids":"[1702863,1702862,1697567,1697566]"}';
//        $originStr = '{"push_recall_conf":"{\"id\":123,\"push_when\":{\"charge_max\":0,\"charge_min\":0,\"time\":2592000},\"push_type\":\"rtdsms\",\"template_ids\":\"[20,21,22]\"}","user_ids":"[1702863,1702862,1697567,1697566,1697565]"}';
//        $originStr = '{"push_recall_conf":"{\"id\":4,\"push_when\":{\"charge_max\":500,\"charge_min\":100,\"time\":3600},\"push_type\":\"getuipush\",\"template_ids\":\"[3,4]\"}","user_ids":"[1456410,1456408,1456402]"}';
//        $originStr='{"push_recall_conf":"{\"id\":2,\"push_when\":{\"charge_max\":0,\"charge_min\":0,\"time\":300},\"push_type\":\"getuipush\",\"template_ids\":\"[\\\"1\\\"]\"}","user_ids":"[1697590,1701174,1700775,1701173,1701175,1201009,1701154,1086590,1701179,1701176,1701180,1700041,1701178,1700587,1151183,1700284,1700570,1700575,1700588,1700710,1700089,1701021,1103364,1701181,1439778,1697576,1697578,1700365,1178493,1701016,1699716,1700586,1697579,1191325,1700467,1021100,1697584,1701159,1697585,1697574,1700857,1701134,1700107,1700336]"}';
        $originStr = '{
    "push_recall_conf":"{\"id\":4,\"push_when\":{\"charge_max\":0,\"charge_min\":0,\"time\":86400},\"push_type\":\"getuipush\",\"template_ids\":\"[3]\"}",
    "user_ids":"[3107847,1102987,3102990,3106087,2800395,3103271,3098439,3084274,3100257,3107808,3107848,2414409,3107499,3107860,3105616,1701756,3107861,3107815,3107864,3107851,3107661,3105929,1711653,3107859,3107866,3103328,2539627,3107828,3027038,3085621,3107872,3107803,3093175,3107874,2810375,3074291,3091346,3107876,3102508,3107852,3107145,2462137,3107855,3107882,3020394,3107875,3107838,3107880,3106588,3107883,3107885,2012167,3106949,3107887,1493468,2949196,3076950,3101659,3107478,3107708,3063609,3107617,3107964,3107928,3107973,1693801,3107940,3107961,3107963,3107900,3107945,3108005,3108059,3108029,3107863,3108020,3108021,3107182,3107974,3107939,3108016,3107936,3107987,3107951,3108026,3107955,3107965,3108051,3107935,3108077,3097692,3108025,3108022,3108093,3108028,3107970,3108083,3107907,3108067,3068820,3107980,3107969,3108027,3107897,3107826,3107921,3107892,3108008,3107905,3107915,3107982,3060659,3107612,3108001,3108061,3107976,3107918,3107991,3108053,3108073,3108094,3108127,3108118,3107933,3107895,3107985,3108104,3107886,3107904,3107911,3108015,3108107,3108152,3107929,3105846,3108110,3108135,3108064,3108044,3108023,3108048,3107906,3107950,3107999,3108131,3108003,3107972,3108035,3108163,3107919,3107995,3108123,3108102,3108138,3105312,3107922,3108170,3107896,3108158,3108075,3073677,3108049,3108101,3108169,3108171,3107932,3108108,3108057,3108103,3108144,3107971,3108085,3107926,3108142,3107967,3108050,3107944,3107943,3107948,3108058,3107968,3108149,1492722,3108088,3107917,3108113,3108124,3108189,3108002,3108145,3107975,3108033,3107891,3108069,3108125,3108092,3108111,3108084,3107981,3108046,3108040,1386496,3108174,1011631,3108034,3108140,3108036,3108000,3108183,3108162,3108017,3108156,3108052,3108197,3108178,3108186,3108208,3108190,2561054,3107898,1590471,3108147,3108188,3107983,3107958,3108195,3108172,3107953,3108227,3108143,3107942,3108200,3108014,3107894,3108045,3108159,3108078,3108116,3107893,3107913,3107934,3108066,3107994,3108105,3108087,3107908,3108165,3108012,3108179,3108007,3107986,3108211,3107931,3108062,3108209,3108160,3108130,3108154,3108222,3107984,3108187,3108153,3108202,3108230,3106580,3108141,3108055,3108098,3108076,3108137,3108122,3108082,3100335,3107920,3108236,3108006,3108218,3108096,3108207,3108151,3108212,3108009,3107925,3108100,2747430,3108056,3108235,3108242,3108010,3108199,3014240,3107992,3108194,3108043,3108193,3107988,2887263,3106796,3108126,3108192,3107997,3108168,3107927,3108018,3108210,3108244,3108198,3108180,3108086,3107899,3108223,3108228,3108248,3108167,2629278,3108099,3108215,3108095,3108224,3108072,3107947,3108213,3108109,3108203,3108243,3108042,3108234,3107631,3108060,3045527,3108024,3107960,3107923,3081611,3108252,3108139,3108240,3107916,3108260,3105349,3108041,3108205,3108219,2953302,3108250,3108191,3108175,3108115,3108173,3107889,3108239,3108013,3108259,2205766,3108164,3107996,3108038,3108133,3107217,3107748,3108238,3108112,2976990,3108134,3107941,3108265,3108177,3106855,3108237,3108266,3107888,3107959,3107912,3107909,2796935,3108247,3108128,3108106,3108054,3076358,3108258,3108090,2065321,3108275,3101187,3108031,3108091,3107966,3107902,3107946,3108281,3108119,3108276,3108283,3107998,3108255,3108065,3108253,3108196,3108267,3108121,3108136,3107993,3107910,3108220,2960252,3108285,3108274,3108245,3085360,3108068,3108269,2914507,3107952,3025808,3108030,3108278,3107556,3107978,3108146,3107873,3107937,2397708,3108019,3105234,3108290,3108150,3108117,3108132,2957243,3108120,3108280,3108256,3108089,3108302,2775630,3103391,3108284,2877225,3038269,3108270,3108246,3108262,3108074,2037186,2702562,2487460,3051812,3108287,3108286,3108063,3107669,3108011,2873168,3041121,3108039,2958133,3065015,3108310,3108318,3108316,3108277,2618374,2861781,3108322,3108321,3108233,3108184,3107325,3108324,3107497,2906335,3104803,1076707,3108329,3108330,3108338,3108334,3108327,3108336,3108343,1733661,3084449,3108304,3108300,3105784,2780008,3108254,3107954,2981016,3108293,3108351,3099771,1060617,2934393,3108354,3108249,2960267,1396872,3100430,3108357,3108201,3099961,3108352,2768603,3101287,3108081,3108298,3108361,3108348,3108341,3108344,3108229,3108358,3097491,3108356,2910491,3108365,3108047,3072976,3107924,3095204,3108349,3069359,3107956,3108272,3108353,3108368,3108342,1474634,3108364,3108114,3104726,3105272,3085420,3108376,3108366,3106429,3108378,2960464,3108379,3106385,2613201,3047355,3108371,3106876,3108369,1496845,3106085,3108389,3108328,3108388,3103365,3105679,3043822,2962463,2922480,3108360,2862034,3108279,3059512,2567795,2999645,3108217,3107870,3036494,3101857,3104389,3108390,3108332,3108393,3104291,3107630,3106505,3108385,3108399,3108405,3054817,3108392,3108377,3108420,3102256,3108445,3108413,3108434,3108458,3108459,3108417,3108411,3108402,3108446,3108455,3108447,3108466,3108449,3108414,3108426,3108482,3108457,3108419,3108437,3108469,2793621,3108423,3108395,3108441,2949631,3108471,2277469,3108422,3108433,3108483,2732369,3108475,3108470,2900680,3108479,3108478,3108494,3108485,3108428,3108429,3104735,3108456,3108225,3108488,3108412,3108462,3108501,2924492,3108498,3108374,3108403,3108454,3108408,3108400,2774391,3108440,3108404,3108499,3108491,3108489,3108444,3108496,3108430,2440875,3108472,3108438,3108493,3108502,3108481,3108504,3108432,2874195,3108406,2900948,3108424,3108497,3108506,2876432,3030178,3108477,3108509,3051662,3108492,3108292,3108451,3108396,3108442,3108439,3108467,3108473,3064749,3108517,3108511,3108503,3108464,3108507,2089749,2458358,3108418,1943642,3108519,3108536,3108516,3108523,3108524,3108529,3108537,3108522,3108557,3082980,3108528,3088497,3108544,3105629,3101252,1667591,3108461,3108572,3108549,3108551,3108532,3108584,3108587,3108553,1034847,3065116,3108545,3108566,3108560,3108540,3108586,3108543,3108575,3108589,3107977,3108580,3108541,3108567,3108409,3108546,3108520,3108590,3108526,3108596,3097399,3108582,3108548,3108577,3108530,3108581,3108571,3108535,3108594,3108608,3108561,3108550,3108610,3108605,3108602,3072997,3108604,3108373,3108601,3108603,3108578,3108508,3108563,3108552,3108612,3108622,3108619,3108609,3108562,3108611,3108632,3108607,3108591,3108626,2847705,3108615,3108628,3108547,3108635,3108539,3092615,3108595,3081520,3108555,3108630,3108588,3108565,3108600,3108538,3108637,3108534,3108542,3108410,3108407,3108573,3108525,2398464,2983703,3108606,3108570,2807547,3108638,3108616,3108621,3108642,3108644,3108641,3108639,3108617,3108599,3107438,3108558,3108627,3108636,3108623,3108533,3108583,2180308,3096656,3108640,3050274,3108648,2980837,3107387,3108593,3108574,3108624,2901551,3108620,2984500,3084296,3108650,3108425,3108613,2959587,3108643,2900792,3108518,1221070,3108505,3108579,3108521,3108654,3054945,3108629,2799074,3106473,3108659,3108556,1684119,3108453,1909327,3107587,2935478,3029861,2940594,3108176,2862046,3108382,3104786,3108660,3105330,3108656,3108576,3108568,3108663,3108435,3104767,3036014,3108655,3108666,3108653,3101577,2644804,3096407,3070688,3108672,3108527,3044031,2950419,3108670,3096272,3108673,3108671,2713324,2262983,3107787,3074390,3066844,3108677,3098031,1930434,3108651,3060488,3108633,3002126,3108486,3108679,2451859,1462136,2792761,3108421,3108690,3108460,3108592,3108691,3105212,3108692,3107786,2858575,3043353,2875267,1752898,2925341,3094354,3107856,3108698,3108699,3098838,3107779,3085495,3104359,3108452,3108693,3108695,3108701,3101503,1426520,3108702,3107865,2760851,2847613,3048087,3108684,3087466,3105663,3108661,3108703,3105847,3076369,3090717,2968667,2932733,3107105,3108710,1508377,3108711,2365387,3073195,2729782,2200988,2801607,1673814,3108313,3108664,3096457,3100328,3108717,2467384,3108367,1519486,3108720,3064169,3095035,2172228,2107173,3108694,1684294,2487817,2624485,3108726,2728288,3106758,3107467,3051647,3075581,2970286,3108723,3108728,2571393,2967485,3108724,2704129,3108729,3108727,3108730,3108725,3027146,3085820,2479305,3108732,3108733,2622888,3108736,3108734,3108737,2830607,1308414,3107210,3073061,3108676,3098909,3107265,3053361,3045011,3108741,3108743,3108745,3108746,3108716,3105897,3107413,1453023,1439371]"
}';
        $originData = json_decode($originStr, true);
        $re = MemberRecallService::getInstance()->handlerUserPushConsumer($originData);
        var_dump($re);
        die;
    }


}
